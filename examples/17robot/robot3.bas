100 REM "Setup of engine variables and pins"
110 I1=13: I2=12: I3=11: I4=10
130 EA=2: EB=3
140 PINM EA, 1: AWRITE EA, 0: PINM EB, 1: AWRITE EB, 0
150 PINM I1, 1: PINM I2, 1: PINM I3, 1: PINM I4, 1
160 REM "Engine voltage"
170 V0=240
200 REM "Servo variables - AS is the servo angles, SP the servo pin"
210 REM "Calibration AZ is zero point, AF is multiplicator for full 180"
220 SP=4: AS=90
230 AZ=50: AF=250
240 GOSUB 12000
300 REM "Echo variables"
310 REM "TP is trigger pin, EP is echo pin"
320 TP=5: EP=6
1000 REM "Test code for serial - drive"
1010 INPUT EC
1020 GOSUB 10000
1030 GOTO 1000
9999 END
10000 REM "Process a robot command"
10010 IF EC<1 OR EC=10 THEN  GOSUB 11000: RETURN
10020 ON EC GOSUB 11100,11200,11300,11400,11500,11600,11700,11800,11900
10040 GOSUB 11000
10060 REM "After movement we always look"
10070 IF EC<6 THEN AS=90:  GOSUB 12000:  GOSUB 13000: PRINT "Forward",E
10090 RETURN
11000 REM "Reset engines, all off"
11010 DWRITE I1,0: DWRITE I2,0: DWRITE I3,0: DWRITE I4,0
11030 AWRITE EA,0: AWRITE EB,0
11040 RETURN
11100 REM "Drive backward"
11110 DWRITE I1,1: DWRITE I2,0: DWRITE I3,1: DWRITE I4,0
11120 AWRITE EA,V0: AWRITE EB,V0: DELAY 200
11140 AWRITE EA,V0/2: AWRITE EB,V0/2: DELAY 500
11150 RETURN
11200 REM "Drive forward"
11210 DWRITE I1,0: DWRITE I2,1: DWRITE I3,0: DWRITE I4,1
11220 AWRITE EA,V0: AWRITE EB,V0: DELAY 200
11230 AWRITE EA,V0/2: AWRITE EB,V0/2: DELAY 500
11240 RETURN
11300 REM "turn left"
11310 DWRITE I1,0: DWRITE I2,1: DWRITE I3,1: DWRITE I4,0
11320 AWRITE EA,V0: AWRITE EB,V0: DELAY 250
11330 RETURN
11400 REM "turn right"
11410 DWRITE I1,1: DWRITE I2,0: DWRITE I3,0: DWRITE I4,1
11420 AWRITE EA,V0: AWRITE EB,V0: DELAY 250
11430 RETURN
11500 REM "Boost forward for obstacles"
11510 DWRITE I1,0: DWRITE I2,1: DWRITE I3,0: DWRITE I4,1
11520 AWRITE EA,255: AWRITE EB,255: DELAY 500
11530 RETURN
11600 REM "Unused"
11610 RETURN
11700 REM "Full scan from right to left"
11710 FOR AS=0 TO 180 STEP 30
11720 GOSUB 12000: GOSUB 13000: PRINT AS,E
11730 NEXT
11740 AS=90: GOSUB 12000
11750 RETURN
11800 REM "look right"
11810 AS=0: GOSUB 12000: GOSUB 13000
11820 PRINT "Looking right",E
11830 AS=90: GOSUB 12000
11840 RETURN
11900 REM "look left"
11910 AS=180:  GOSUB 12000: GOSUB 13000
11920 PRINT "Looking left",E
11930 AS=90:  GOSUB 12000
11940 RETURN
12000 REM "Servo action code - AS is servo angle"
12010 REM "Calibration AZ zero point, AF full angle "
12020 PINM SP,1
12030 DWRITE SP,0
12040 P=MAP(AS, 180, 0, AF, AZ)
12050 FOR I=1 TO 40: DELAY 20: PULSE SP, P: NEXT
12060 RETURN
13000 REM "Sensor code, return value in E"
13010 PINM TP,1: PINM EP,0
13020 DWRITE TP,0
13030 PULSE TP,10
13040 E0=PULSE(EP,1,30)
13050 E=MAP(E0, 1000, 0, 1724, 0)
13060 RETURN

